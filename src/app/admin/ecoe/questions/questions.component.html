<nz-content *ngIf="stations">
  <div *ngFor="let station of stations">
    <div *ngFor="let qblock of station.qblocks">
      <nz-table #table
                [nzData]="qblock.questions"
                [nzPageSize]="8"
                [nzTitle]="addButton">
        <thead>
          <tr>
            <th [nzExpand]="true">
              <a (click)="loadQuestions()">
                <i nz-icon icon-25 type="reload" [nz-tooltip] [nzPlacement]="'bottom'" [nzTitle]="'REFRESH' | translate"></i>
              </a>
            </th>
            <th>{{"ORDER" | translate}}</th>
            <th [nzWidth]="'30%'">{{"DESCRIPTION" | translate}}</th>
            <th>{{"REFERENCE" | translate}}</th>
            <th>{{"QUESTION_TYPE" | translate}}</th>
            <th>{{"OPTIONS" | translate}}</th>
            <th></th>
          </tr>
        </thead>

        <tbody>
          <ng-template ngFor let-item [ngForOf]="table.data">
            <tr>
              <td [nzShowExpand]="item.options.length > 0"
                  [(nzExpand)]="item.expand"
                  (nzExpandChange)="loadOptionsByQuestion($event, item.id)">
              </td>

              <td>
                <ng-container *ngIf="!editCache[item.id].edit">
                  {{item.order || "-"}}
                </ng-container>

                <ng-container *ngIf="editCache[item.id].edit">
                  <input type="text" nz-input [nzSize]="'small'" [(ngModel)]="editCache[item.id].order">
                </ng-container>
              </td>

              <td>
                <ng-container *ngIf="!editCache[item.id].edit">
                  {{item.description}}
                </ng-container>

                <ng-container *ngIf="editCache[item.id].edit">
                  <input type="text" nz-input [nzSize]="'small'" style="width: 80%;" [(ngModel)]="editCache[item.id].description">
                </ng-container>
              </td>

              <td>
                <ng-container *ngIf="!editCache[item.id].edit">
                  {{item.reference}}
                </ng-container>

                <ng-container *ngIf="editCache[item.id].edit">
                  <input type="text" nz-input [nzSize]="'small'" [(ngModel)]="editCache[item.id].reference">
                </ng-container>
              </td>

              <td>
                <ng-container *ngIf="!editCache[item.id].edit">
                  {{item.question_type}}
                </ng-container>

                <ng-container *ngIf="editCache[item.id].edit">
                  <nz-select style="width: 150px;"
                             [nzSize]="'small'"
                             [nzShowSearch]="true"
                             [(ngModel)]="editCache[item.id].question_type">
                    <nz-option *ngFor="let option of question_type_options"
                               [nzLabel]="option.label | translate"
                               [nzValue]="option.type">
                    </nz-option>
                  </nz-select>
                </ng-container>
              </td>

              <td>{{item.options.length}}</td>

              <td>
                <ng-container *ngIf="!editCache[item.id].edit">
                  <i nz-icon type="folder-add" [theme]="'twotone'"
                     [nz-tooltip] [nzTitle]="'MOVE_TO' | translate"
                      tappable>
                  </i>

                  <nz-divider [nzType]="'vertical'"></nz-divider>

                  <i nz-icon type="edit" [theme]="'outline'"
                     [nz-tooltip] [nzTitle]="'EDIT' | translate"
                     (click)="startEdit(item.id)" tappable success-color>
                  </i>

                  <nz-divider [nzType]="'vertical'"></nz-divider>

                  <a nz-popconfirm [nzTitle]="'DELETE_CONFIRMATION' | translate" (nzOnConfirm)="deleteItem(item['$uri'])">
                    <i nz-icon type="delete" [nz-tooltip] [nzTitle]="'DELETE' | translate" danger-color></i>
                  </a>
                </ng-container>

                <ng-container *ngIf="editCache[item.id].edit">
                  <i nz-icon type="save"
                     [nz-tooltip] [nzTitle]="(editCache[item.id].new_item ? 'SAVE' : 'UPDATE') | translate"
                     (click)="editCache[item.id].new_item ? saveItem(item.id) : saveEditItem(item.id)"
                     success-color tappable>
                  </i>

                  <nz-divider [nzType]="'vertical'"></nz-divider>

                  <i nz-icon type="close-circle"
                     [nz-tooltip] [nzTitle]="'CANCEL' | translate"
                     (click)="cancelEdit(item.id)"
                     danger-color tappable>
                  </i>
                </ng-container>
              </td>
            </tr>
            <tr [nzExpand]="item.expand">
              <td></td>
              <td colspan="5">
                <nz-table #optionTable [nzData]="item.optionsArray" [nzSize]="'middle'" [nzShowPagination]="false">
                  <tbody>
                    <tr *ngFor="let option of optionTable.data; let i = index">
                      <td>
                        <ng-container *ngIf="!editCache[item.id].edit">
                          {{option.order}}
                        </ng-container>

                        <ng-container *ngIf="editCache[item.id].edit">
                          <input type="text"
                                 nz-input
                                 [nzSize]="'small'"
                                 required
                                 [(ngModel)]="editCache[item.id].optionsArray[i].order">
                        </ng-container>
                      </td>

                      <td>
                        <ng-container *ngIf="!editCache[item.id].edit">
                          {{option.label}}
                        </ng-container>

                        <ng-container *ngIf="editCache[item.id].edit">
                          <input type="text"
                                 nz-input
                                 [nzSize]="'small'"
                                 required
                                 [(ngModel)]="editCache[item.id].questionsArray[i].label">
                        </ng-container>
                      </td>

                      <td>
                        <ng-container *ngIf="!editCache[item.id].edit">
                          {{option.points}}
                        </ng-container>

                        <ng-container *ngIf="editCache[item.id].edit">
                          <input type="text"
                                 nz-input
                                 [nzSize]="'small'"
                                 required
                                 [(ngModel)]="editCache[item.id].questionsArray[i].points">
                        </ng-container>
                      </td>
                    </tr>
                  </tbody>
                </nz-table>
              </td>
            </tr>
          </ng-template>
        </tbody>

        <ng-template #addButton>
          <nz-breadcrumb>
            <nz-breadcrumb-item>
              {{station.name}}
            </nz-breadcrumb-item>
            <nz-breadcrumb-item>
              {{qblock.name}}
            </nz-breadcrumb-item>
          </nz-breadcrumb>
          <!--<button nz-button [nzType]="'primary'" class="margin-left" (click)="addItem()">-->
            <!--<i nz-icon [type]="'plus-circle'" [theme]="'twotone'" icon-16></i>-->
            <!--{{"ADD_QUESTION" | translate}}-->
          <!--</button>-->

          <nz-tag style="float: right;" [nzMode]="'closeable'" [nzColor]="'geekblue'" (nzOnClose)="deleteFilter()" *ngIf="qblockId">
            <i nz-icon type="filter" [theme]="'twotone'"></i>
            {{"QBLOCK" | translate}} {{qblockId}}
          </nz-tag>
        </ng-template>
      </nz-table>
    </div>
  </div>
</nz-content>
